# Specialist Prompt: P1.1 — Fix Tool Calling Pipeline

## Your Role
You are the **Tool Pipeline Specialist**. Your job is to replace the broken `zodToJsonSchema` stub in the model client so that tool calling actually works with OpenAI and Anthropic APIs.

## Context
The current `zodToJsonSchema` in `src/models/client.ts:342-349` returns an empty schema for all tools:
```typescript
private zodToJsonSchema(schema: unknown): Record<string, unknown> {
  return { type: 'object', properties: {}, required: [] };
}
```
This means every tool call sends empty parameter definitions to the LLM, so the model never knows what arguments to provide.

## What You Need to Do

### Step 1: Install the library
```bash
npm install zod-to-json-schema
```

### Step 2: Replace the stub
```typescript
// In src/models/client.ts
import { zodToJsonSchema as convertZodToJsonSchema } from 'zod-to-json-schema';

// Replace the private method:
private zodToJsonSchema(schema: unknown): Record<string, unknown> {
  if (schema && typeof schema === 'object' && '_def' in schema) {
    // It's a Zod schema — convert it
    const jsonSchema = convertZodToJsonSchema(schema as z.ZodType, {
      target: 'openApi3',
      $refStrategy: 'none',
    });
    // Remove the top-level $schema key that some providers don't accept
    const { $schema, ...rest } = jsonSchema as Record<string, unknown>;
    return rest;
  }
  return { type: 'object', properties: {}, required: [] };
}
```

### Step 3: Verify Anthropic format compatibility
Anthropic expects `input_schema` with `type: 'object'` at the top level. The current code in `completeAnthropic` wraps the result:
```typescript
const tools = options.tools?.map(tool => ({
  name: tool.name,
  description: tool.description,
  input_schema: {
    type: 'object' as const,
    ...this.zodToJsonSchema(tool.parameters),
  },
}));
```
This will double-wrap `type: 'object'` since `zodToJsonSchema` already returns it. Fix:
```typescript
input_schema: this.zodToJsonSchema(tool.parameters) as Anthropic.Tool.InputSchema,
```

### Step 4: Write tests
Create `src/models/client.test.ts`:
```typescript
import { describe, it, expect } from 'vitest';
import { z } from 'zod';
// Test that Zod schemas convert correctly for both providers
// Test edge cases: optional fields, enums, nested objects, arrays
```

## Files to Modify
- `src/models/client.ts` — Replace stub, fix Anthropic format
- `package.json` — Add `zod-to-json-schema` dependency

## Files to Create
- `src/models/client.test.ts` — Tests for schema conversion

## Acceptance Criteria
- [ ] `npm run typecheck` passes
- [ ] `npm test` passes (all existing + new tests)
- [ ] Tool schemas are correctly generated for a Zod schema with strings, numbers, enums, and optionals
- [ ] OpenAI format: `{ type, properties, required }` at top level
- [ ] Anthropic format: same structure works with `input_schema`
- [ ] No double-wrapping of `type: 'object'`

## Branch
Work in: `worktree/p1-tool-pipeline`

## After Completion
1. Update PLAN.md — check off P1.1 tasks
2. Update CHANGELOG.md
3. Request security scan: `security-agent scan /path/to/worktree`
