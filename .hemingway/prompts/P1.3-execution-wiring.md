# Specialist Prompt: P1.3 — Wire Samantha → Agent Execution

## Your Role
You are the **Execution Wiring Specialist**. Your job is to connect Samantha's task classification to actual agent execution so that when a user says "review my PRs," it doesn't just classify — it actually runs the GitHub agent.

## Context
Currently `Samantha.process()` in `src/core/samantha.ts`:
1. Classifies the input (work/personal, category, priority) ✅
2. Creates a `Task` object ✅
3. Returns a delegation response message ✅
4. **Never actually executes the task** ❌

The `AgentRegistry` has `executeTask()` and `findAgentForTask()` but they're never called from the main flow.

## What You Need to Do

### Step 1: Connect Samantha to AgentRegistry
```typescript
// In src/core/samantha.ts — modify the process() method

import { getAgentRegistry } from '../agents/index.js';

async process(input: string): Promise<{
  response: string;
  task?: Task;
  agentType?: AgentType;
  executionResult?: TaskResult;  // NEW
}> {
  // ... existing classification and task creation code ...

  // NEW: Actually execute the task
  const registry = getAgentRegistry();
  const agent = registry.findAgentForTask(task);

  if (agent) {
    this.emit('delegated', task, agent.getConfig().id);
    task.assignedAgent = agent.getConfig().id;
    task.status = 'in_progress';
    this.memory.storeTask(task);

    try {
      const result = await agent.execute(task);
      this.memory.storeTask(task); // Update with result

      // Build response from agent output
      const agentResponse = result.success
        ? result.output || 'Task completed successfully.'
        : `Task failed: ${result.error}`;

      const assistantMessage: Message = {
        id: generateId(),
        role: 'assistant',
        content: agentResponse,
        timestamp: new Date(),
        agentId: agent.getConfig().id,
      };
      this.conversationHistory.push(assistantMessage);
      this.memory.addMessage(assistantMessage);

      return {
        response: agentResponse,
        task,
        agentType: classification.intent.type === 'unclear' ? 'work' : classification.intent.type,
        executionResult: result,
      };
    } catch (error) {
      task.status = 'failed';
      this.memory.storeTask(task);
      return {
        response: `I routed this to the ${agent.getConfig().name}, but it encountered an error: ${(error as Error).message}`,
        task,
        agentType: classification.intent.type === 'unclear' ? 'work' : classification.intent.type,
      };
    }
  }

  // Fallback: no agent found
  return { response, task, agentType: ... };
}
```

### Step 2: Update CLI to show execution results
```typescript
// In src/cli.ts — modify the REPL display

const result = await samantha.process(trimmed);
spinner.stop();

// Show Samantha's response
console.log(chalk.green(`\nSamantha: ${result.response}\n`));

// Show task info if created
if (result.task) {
  const statusColor = result.task.status === 'completed' ? chalk.green :
                      result.task.status === 'failed' ? chalk.red : chalk.yellow;
  console.log(chalk.dim(`Task: ${result.task.title}`));
  console.log(statusColor(`Status: ${result.task.status}`));
  if (result.task.assignedAgent) {
    console.log(chalk.dim(`Agent: ${result.task.assignedAgent}`));
  }
  console.log('');
}
```

### Step 3: Add streaming output support
```typescript
// In src/agents/base.ts — add streaming to execute()

// Emit progress messages that the CLI can display
this.emit('message', `Working on: ${task.title}...`);

// In the agent loop, emit each iteration
this.emit('thinking', `Step ${iterations}: Processing...`);
```

### Step 4: Handle the case where no model is available
```typescript
// Agents without a model should return a helpful error, not crash
async execute(task: Task): Promise<TaskResult> {
  if (!this.modelId) {
    return {
      success: false,
      error: `${this.config.name} has no model available. Configure an API key or start a local model server.`,
    };
  }
  // ... rest of execute
}
```

## Files to Modify
- `src/core/samantha.ts` — Connect process() to agent execution
- `src/cli.ts` — Display execution results and status
- `src/agents/base.ts` — Add graceful handling for no-model case

## Acceptance Criteria
- [ ] `npm run typecheck` passes
- [ ] When a user types "review my PRs", Samantha classifies it AND routes to the GitHub agent
- [ ] Agent execution results are displayed in the CLI
- [ ] Failed executions show clear error messages
- [ ] Missing model case is handled gracefully (not a crash)
- [ ] Task status is updated in memory (pending → in_progress → completed/failed)

## Branch
Work in: `worktree/p1-execution-wiring`
